---
title: "Саенко_ФА"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE, message= FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Загрузим датасет из прошлого задания
```{r}
library(readxl)
df <- read_excel("C:/Users/Anastasia/Downloads/F00007630-WV6_Data_Ukraine_2011_Excel_v20180912.xlsx")
df <- df[,152:160]
```

```{r}
df <- na.omit(df)
```

# Часть 1. Разведовательный ФА
```{r}
library(foreign)
library(psych)
library(GGally)
library(GPArotation)
library(nFactors)
```

# Шаг 1. Анализ применимости ФА в целом

# Для этого посмотрим на корреляции между переменными ( также выведем их список, чтобы помнить, что есть что )
```{r}
colnames(df)
```
```{r}
colnames(df) <- c("V131","V132","V133","V134","V135", "V136","V137","V138", "V139")
ggcorr(df, nbreaks = 5, label = T, size = 4, hjust = 1)
```

Как можно увидеть из графика, есть переменные которые в общем-то не имеют высокой корреляции( например V138 ( неоюходимость подчинения правилам) и V136  ( ценность гражданских прав)). Однако есть и ряд переменных скоррелированных, однако не сильно ( больше 0,5 корреляций не наблюдается). Например, возьмем корреляцию между V139(равные права для женщин) и V136(гражданские права и защита от гос. давления) - 0.5, то есть относительно высокая по сравнению  с остальными. Здесь можно сделать ровно такой же вывод как и  при проведении МГК, соотвественно и предположение будет таким же, - логично предположить, что формируется по крайней мере две группы - ценностей более авторитарых ( армия и  т.д например V132( власть религии) и V135( ценность армии и дисциплины) относительно других показателей сильно скоррелированы ( корр - 0.4)) и ценностей более демократических. Мы видим а) корреляции между ценностями относящимся к одной из групп ( предположительно) б) малую корреляцию между показатели двух разных групп. В рамках ФА такое наблюдение может также давать основания предположить, что можно будет выделить как минимум два факторы, которые и будут отражать эти разные ценности. 

Проверим целесообразность тестом  Kaiser-Meyer-Olkin:
```{r}
KMO(df)
```
Данная статистика основывается на сравнении частных и обычных коэффициентов  корреляции. Если частные коэффициенты больше это предполагало бы, что мы можем разбивать данные, но на крайне малые группы( например по две переменные) > смысл проведения ФА терялся бы. Поэтому необходимо, чтобы обычные коэффициенты корреляции были больше. Как видно из проведенного теста выше метрика составила больше 0.8 почти для всех переменных ( кроме власти религии V132 и V135 дисциплины и армии, что косвенно также говорит о прошлом выводе о делении на группы). Средняя статистика составила 0,81 - поэтому можно сказать, что коэффициенты корреляции ( общие) больше и проведения ФА оправдано.

# Шаг 2. Выбор количества факторов 

Проведем несколько тестов для определения оптимального количества факторов 

```{r}
corr <- cor(df)
VSS.scree(corr)
```
На графике необходимо отследить относительную скорость изменения собственных значений или вариации в зависимости от количества компонент. Здесь несовсем однозначно можно определить по визуализации: планомерное снижение начинается после значения 3 (значит надо взять два фактора, как и предпологалось), но с другой стороны и после 4 идет совсем замедленное снижение ( то есть надо было бы взять 3 фактора). Предположим, в соотвествие с нашей прошлой гипотезой, что факторов все же два и проверим это с помощью собственных значений. 


```{r}
eigen(cor(df))$values
```
Как видим в общем-то гипотеза подтвердилась, первые два собственных значения превышают 1, а значит и необходимо взять 2 фактора. Проведем еще один формальный тест, проведя репликацию по параметрам выборки на 1000 независимых сэмплах ( с одниковыми параметрами к выборке), что тоже позволит оценить количество факторов. 
```{r}
eigen <- eigen(cor(df)) # get eigenvalues
p <- parallel(var = ncol(df), subject = nrow(df), rep = 1000)$eigen$mevpea
screeplot <- nScree(x=eigen$values, aparallel = p)
plotnScree(screeplot)
```

Как видим параллельное тестирование также подтверждает, что необходимо взять 2 фактора ( только в двух случаев результаты по изначальной выборке превышают результаты по репликациям)

# Шаг 3. Проведения РФА ( EFA)
Так как теперь точно выяснили количество факторов можем непосредственно перейти к проведению анализа. 
```{r}
efa1 <- fa(r = corr, nfactors = 2, fm = "pa", rotate = "varimax") 
efa1
```
Рассмотрим сначала спецификации непосредственно факторов. PA1: мы видим, что фактор имеет достаточно высокую факторную нагрузку для следующих переменных:V131(субсидии бедным),V133( свободные выборы),V134(помощь безработным),V136(гражданские права),V137(равенство доходов),V139(права женщин). В РА2 большой факторной нагрузкой обладают следующие переменные: V132(власть религии), V135(армия), V138(люди подчиняются правилам) и также относительно V137 ( уравнивание доходов, но незначительный вес по сравнению с другими переменными). Мы видим, что выдвинутая ранее гипотеза о разделении на относительно автоританые и относительно демократические ценности согласно спецификациях подтверждается. Также можем посмотреть на значение com - в среднем переменная относится  к конкретно одному фактору, что тоже говорит о том, что разделение достаточно четкое( об этом же говорит mean item complexity - 1.1,  то есть в среднем одна переменная относится больше к одному фактору).  Однако мы также видим, что имеет место крайне высокой специфичной вариации для каждой из переменных, то есть осталось много неучтенной или необъясненной вариации и какие-то факторы не учтены, что конечно ставит под вопрос качество. 
Мы видим из консольной выдачи, что факторы суммарно объясняют лишь 0,37 вариации (РА1 - 0,28 и РА2 - 0,09), то есть остальная часть ( 0,63) упущена факторами. Если " забыть" об упущенной вариации также можно увидеть, что больше вариации объясняет фактор 1 ( 0.75) - но это вполне логично, учитывая что к нему относятся больше переменных. 
Однако другие метрики качества по модели говорят о следующем: например, RMSR ( который сравнивает наблюдаемую ковариацию по исходным данным и предсказывает значение ковариации по модели  и берет разницу между ними > нужно чтобы это значение было как можно меньше) - 0.03, что является относительно небольшой величиной, а значит и модель хорошо подогнана под данные. 
Также можем обратить внимание на квадрат корреляции между  наблюдаемыми  значениями и предсказанными значениями факторов: у первого фактора он составил 0.82, у второго 0.57 в целом первый фактор подобран достаточно эффективно, второй менее эффективно, однако как было показано раньше разделение соотвествует изначальным предположением. 

Вывод по промежуточному разведовательному ФА: в ходе разведовательного ФА удалось получить достаточно качественное решение ( судя по метрикам качества) и подтвердить гипотезу о том, что ценности делятся на авторитарные и демократические ( так как выделилось два фактора соответсвующие этому разделению). Первый фактор - отвечает за демократическиеценности, второй - за авторитарные. 

## Этап 2. Конфирматорный факторный анализ


На прошлом этапе мы выявили два фактора ценностей: демократические и недемократические ( или авторитарные ). Конфирматорный анализ необходим по следующим причинам: во-первых логично предположить,что корреляция между демократическими и недемократическими ценностями существует ( скорее всего негативная),поэтому нужно включить в анализ это допущение. Во-вторых, как мы увидели на прошлом этапе доля необъясненной вариации кардинально высока. В третьих, так как корреляции между показателями не самые высокие с помощью конфирматорного анализа можно протестировать насколько целесообразно разделение всего на три категории, где перевес явно в сторону дем.ценностей.Чисто с содержательной точки зрения в ценностях неявным образом можно увидеть три категории - автоританых ценностей, демократических(  в виде выборов и прав) и некоторый экономический блок причем с уклоном в ценности уже социального государства.

С этой идее специфицируем модель для конфирматорного анализа: 
```{r}
library(foreign)
library(psych)
library(GGally)
library(GPArotation)
library(nFactors)
library(lavaan)
library(semTools)
library(semPlot)
```

```{r}
print(efa1$loadings, cutoff=0.3)
```
```{r}
cfa1 <- 'dem =~ V131 + V133 + V134 + V136 + V137 + V139
notdem =~ V132 + V135'
model1 <- cfa(cfa1, df)
summary(model1, fit.measures = TRUE, standardized = TRUE)
```

Сначала обратим внимание на метрики качества модели. 

Смотрим на статистики по model test user model:

а) p-value =0, то есть модель значима

б) degrees of freedom это разница между источниками информации и параметрами - 26, положительное число, то есть модель как минимум идентифицируема

Так как n  наблюдений большое ( 1500), то вполне можно ожидать, что статистика хи-квадрат завышена. Поэтому смотрим на RMSE - 0.07. Как мы видим это значение выше условной границы в 0,05 ( о чем свидетельствует и доверительный интервал никак не накрывающий 0,05 [0.067; 0.087]). p-value ( гипотеза в том, что РМСЕ не превышает 0,05) составляет 0, то есть гипотезу отвергаем, значит РМСЕ больше 0,05, что говорит о том, что модель не качественная.

Смотрим на следующие метрики сравнения с базовой моделью без совместной изменчивости: 

1) CFI -  0.93

2)  Tucker-Lewis Index (TLI) -0.91 

Как мы видим оба не больше 0,95 то есть приращение данных не достаточно, что опять же говорит, что модель следует улучшить. 

3) SRMR смотрим на среднее отклонение наблюдаемых значений ковариации от предсказанных моделью ( то есть стремимся ее минимизировать) -  0.045. Если брять за условное пороговое значение 0,08, то ошибки невелики и разница формально допустимая.

**Посмотрим на результаты самого факторного анализа**

Посмотрим на  стандартизированные факторные нагрузки в группах:

1)   в группе демократических ценностей наибольшей факторной нагрузкой ( 0,71) обладает переменная V133 или переменная про свободные выборы. В группе недемократических ценностей это переменная V132 - власть религии. 

Так как мы допускаем корреляцию между факторами посмотрим на ков. матрицу - мы видим отрицательную корреляцию( стандартизированный показатель -0. 15) слабой силы, но так как p-value 0 связь значима.

# Визуализируем получившуюся модель 
```{r}
semPaths(model1, "std", rotation = 2, colFactor = 0, sizeMan = 20, sizeMan2 = 10, sizeLat = 15, edge.color = "black",
edge.label.cex = 1, esize = 1, mar = c(3,10,3,10))
```
Проинтерпретируем данную диаграмму: 

В группе недемократических ценностей наибольшую факторную нагрузку ( берем показатель в квадрате, если говорим о том сколько вариации в переменной объясняетс фактор, то есть в случае переменной 0,72) имеет переменная V132 - власть религии, при этом мы видим, что специфичность ( то есть необъясненная вариация)  - 0.27, что относительно немного ( в сравнении с другими показателями). Также мы можем сказать, что именно этот показатель имеет высокую корреляцию с факторов - 0,85. 
А вот второй показатель менее скоррелирован с факторов ( 0,42), а также имеет меньшую долю объясненной фактором вариации всего лишь 0,17 ( берем квадрат факт нагрузки или просто из 1 вычитаем специфичность)- то есть доля оставшаяся не объясненной предельно высока. 

Во второй группеси ситуация не сильно лучше - практически относительно всех показателей доля не объясненной вариации высока ( половина не объяснена), кроме переменной V133(свободные выборы) ( на грани - 0,49 не объясненной вариации ). Соотвественно эта же переменная имеет наибольшую факторную нагрузку ( 0, 71 или 0,5 объясненной вариации). 

Также на диаграмме можем увидеть уже ранее установленные нами параметры - корреляцию между факторами ( -0.16). 

Глобальный вывод, который можно сделать по диаграмме - доля объясненной факторами вариаций достаточно мала и соотвественно модель вряд ли является эффективной в плане приложения уже на ген. совокупность, однако со стороны содержательной интерпретации( деления на демократические и не демократические ценности) вполне логична, то есть если посмотреть на факторную нагрузку она самая большая у свободных выборов ( самой базовой дем. ценности) и у власти религии ( из имеющихся данных тоже достаточно фундаментальная НЕдемократическая ценность). 
# Улучшение модели 
```{r}
mepc <- modindices(model1, sort. = TRUE)
mepc
```
```{r}
cfa2 <- 'dem =~ V131 + V133 + V134 + V136 + V137 + V139
notdem =~ V132 + V135
notdem =~ V137'
model2 <- cfa(cfa2, df)
summary(model2, fit.measures = TRUE, standardized = TRUE)

```
```{r}
anova(model1, model2)
```

Таким образом, был добавлен еще один параметр, но заметного улучшения модели он не привел, хотя и является значимым. Например, по сути только один показатель улучшился -CFI и то по грани ( 0.95).Также важно отметить, что  в качестве параметра мы взяли корреляцию между фактором и переменной - а это очень специфичный случай, который не имеет под собой оснований  и ухудшает интерпретируемость модели, поэтому его проще исключить, так как весомого улучшения он все равно не дает. 
Дабы сократить место и не вставлять это, можно просто сказать, что дальнейший перебор параметров и их комбинаций также не приводит к улучшений значительному модели. Это может быть связано с тем, что  в самих данных тем не менее нет ярко выраженных категорий, то есть мы разделили на условно две, однако прослеживается и третья категория - экономического блока. Также очевидно между информацией недостаточная корреляция ( что опять же говорит о том, что на 9 показателей имеются слишком ярко выраженные индивидуальные категории и необходимость снижать размерность в общем-то отпадает). 
Если дальше думать почему подверждающий анализ не показал эффективного результата можно выделить следующее: слишком большой перевес в сторону демократических ценностей, недостаток данных второй категории; не ярко выраженные категории, по сути их больше, чем две и дублирующей информации не так много.Возможно выделить три фактора (блок авторитарных ценностей, экономических и прав,выборов) было бы логичных шагом, но тут уже встает вопрос о расширении набора показателей. 

Итого: конфирматорный анализ не показал высокого качества модели, однако показал,что по крайней мере модель хорошо идентифицируема ( разница между источниками информации и количеством параметров положительная), также была найдена отрицательная корреляция между факторами. Однако, доля специфичности осталась высокой, что говорит о том, что подобранные факторы не объясняют преимущественную долю вариации и на разделение или даже не разделение ценностей могут влиять упущенные нами факторы. 
